rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNGSI BANTUAN OTENTIKASI ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }

    // --- FUNGSI VALIDASI DATA ANIME ---
    function isValidAnimeData(data) {
      return data.title is string && data.title.size() > 0 &&
             data.description is string && data.description.size() > 0 &&
             data.streamUrl is string && data.streamUrl.matches('https?://.+') &&
             data.coverImageUrl is string && data.coverImageUrl.matches('https?://.+') &&
             data.genres is list && data.genres.size() > 0 &&
             data.episodes is number &&
             (!('rating' in data) || data.rating is number);
    }

    // --- FUNGSI VALIDASI DATA EPISODE ---
    function isValidEpisodeData(data) {
      return data.animeId is string && data.animeId.size() > 0 &&
             data.episodeNumber is number && data.episodeNumber > 0 &&
             data.title is string && data.title.size() > 0 &&
             data.videoUrl is string && data.videoUrl.matches('https?://.+');
    }
    
    // --- ATURAN UNTUK KOLEKSI 'ANIMES' ---
    match /animes/{animeId} {
      
      allow read: if true;

      allow create: if isAdmin() && isValidAnimeData(request.resource.data)
                      && request.resource.data.createdAt == request.time
                      && request.resource.data.updatedAt == request.time;

      allow update: if isAdmin() && isValidAnimeData(request.resource.data)
                      && request.resource.data.updatedAt == request.time
                      && request.resource.data.createdAt == resource.data.createdAt;

      allow delete: if isAdmin();

      // --- ATURAN UNTUK SUB-KOLEKSI 'EPISODES' ---
      match /episodes/{episodeId} {

        // Siapa saja boleh membaca daftar episode.
        allow read: if true;

        // Hanya admin yang bisa membuat episode baru.
        allow create: if isAdmin() && isValidEpisodeData(request.resource.data)
                        && request.resource.data.createdAt == request.time
                        // Pastikan episode yang dibuat sesuai dengan anime induknya
                        && request.resource.data.animeId == animeId;
        
        // Hanya admin yang bisa mengubah atau menghapus.
        allow update, delete: if isAdmin();
      }
    }
  }
}
